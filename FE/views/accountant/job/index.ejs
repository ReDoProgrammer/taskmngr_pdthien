<div class="row">
  <div class="offset-md-9 col-md-3 text-right">
    <!-- Another variation with a button -->
    <div class="input-group">
      <input type="text" class="form-control" placeholder="Seach any job" id="txtSearch" />
      <div class="input-group-btn">
        <button class="btn btn-info" type="submit" id="btnSearch">
          <i class="fa fa-search" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>
</div>


<table class="table table-striped table-hover js-table mt-2">
  <thead>
    <th><input type="checkbox" name="job_checked"></th>
    <th>#</th>
    <th>Customer</th>
    <th>Job</th>
    <th>Receive date</th>
    <th>Delivery date</th>
    <th>Status</th>
    <th></th>
  </thead>
  <tbody id="tblJobs"></tbody>
</table>



<nav aria-label="..." class="mt-3">
  <ul class="pagination pagination-sm">
    <li class="page-item disabled">
      <a class="page-link" href="#" tabindex="-1">1</a>
    </li>
    <li class="page-item"><a class="page-link" href="#">2</a></li>
    <li class="page-item"><a class="page-link" href="#">3</a></li>
  </ul>
</nav>

<!-- <div id="contextMenu" class="dropdown clearfix">
  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu"
    style="display:block;position:static;margin-bottom:5px;" id="funcMenu">
  </ul>
</div> -->



<%-include('job-detail-modal')%>


  <!-- <link rel="stylesheet" href="/css/bootstrap-table.min.css"> -->
  <script src="/js/common.js"></script>
  <!-- <script src="/js/bootstrap-table.min.js"></script> -->

  <script>
    var search = "";
    var page = 1;
    var jobId = '';
    var customerId = '';

    var parentsData = {
      "success": true,
      "parents": [{
        "id": 1531,
        "Firstname": "Austin",
        "Surname": "Ana\u00eblle",
        "schoolId": "046039",
        "schoolName": "ARCAMBAL",
        "commune": "ARCAMBAL"
      }, {
        "id": 2032,
        "Firstname": "Ramos",
        "Surname": "L\u00e8i",
        "schoolId": "046043",
        "schoolName": "J CALVET",
        "commune": "CAHORS"
      }, {
        "id": 3036,
        "Firstname": "Baker",
        "Surname": "Salom\u00e9",
        "schoolId": "046043",
        "schoolName": "Z LAFAGE",
        "commune": "CAHORS"
      }, {
        "id": 1724,
        "Firstname": "Berry",
        "Surname": "Marl\u00e8ne",
        "schoolId": "046044",
        "schoolName": "J CALVET",
        "commune": "CAHORS"
      }]
    };

    var $table = $('.js-table');

    // $table.find('.js-view-parents').on('click', function (e) {
    $(document).on("click", "button[name='js-view-parents']", function (e) {
      var $btn = $(e.target), $row = $btn.closest('tr'), $nextRow = $row.next('tr.expand-child');
      $btn.toggleClass('fa-minus');
      // if .expand-chid row exist already, toggle
      if ($nextRow.length) {
        $nextRow.toggle($btn.hasClass('fa-minus'));
        // if not, create .expand-child row
      } else {
        var newRow = '<tr class="expand-child" id="collapse' + $btn.data('id') + '">' +
          '<td colspan="8">' +
          '<table class="table table-condensed table-bordered" width=100% >' +
          '<thead>' +
          '<tr>' +
          '<th class="text-right  ">#</th>' +
          '<th>Level</th>' +
          '<th>Editor</th>' +
          '<th>Q.A</th>' +
          '<th>DC</th>' +
          '<th>Uploaded by</th>' +
          '<th>Uploaded at</th>' +
          '<th>Status</th>' +
          '<th><input type="checkbox" name="check_all_tasks"></th>' +
          '</tr>' +
          '</thead>' +
          '<tbody>';
        jobId = $(this).closest('tr').attr('id');

        GetTasksByJob(jobId)
          .then(data => {
            newRow += data;
            console.log(data);
          })
          .catch(err => {
            console.log(err);
          })
        // if (parentsData.parents) {
        //   $.each(parentsData.parents, function (i, parent) {
        //     newRow += '<tr>' +
        //       '<td>' + parent.Firstname + '</td>' +
        //       '<td>' + parent.Surname + '</td>' +
        //       '<td>' + parent.schoolId + '</td>' +
        //       '<td>' + parent.schoolName + ' ' + parent.commune + '</td>' +
        //       '</tr>';
        //   });
        // }
        newRow += '</tbody></table></td></tr>';
        // set next row
        $nextRow = $(newRow).insertAfter($row);


        /*}
            });*/
      }
    });


    GetTasksByJob = (jobId) => {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: '/accountant/task/list-by-job',
          type: 'get',
          headers: {
            authorization: "Bearer " + localStorage.getItem("accessToken"),
          },
          data: {
            jobId
          },
          success: async function (data) {
            let sIdx = 1;
            let tr = '';
            await data.tasks.forEach(t => {
              tr += '<tr id="' + t._id + '">';
              tr += '<td class="text-right">' + (sIdx++) + '</td>';
              tr += '<td class="font-weight-bold">' + t.level.name + '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '<td>';
              tr += '</td>';
              tr += '</tr>';
            })
            return resolve(tr);

          }
        })
      })

    }


    $(document).on("click", "button[name='btn-job-functions']", function (e) {
      var $contextMenu = $("#contextMenu");
      $contextMenu.css({
        display: "block",
        left: e.pageX,
        top: e.pageY
      });

      jobId = $(this).closest('tr').attr('id');

      $.ajax({
        url: '/sale/job/detail',
        type: 'get',
        headers: {
          authorization: "Bearer " + localStorage.getItem("accessToken"),
        },
        data: {
          jobId
        },
        success: function (data) {


          $('#funcMenu').empty();
          let mn = '';
          mn = '<li id="submit-task"><a tabindex="-1" href="#"> <i class="fa fa-paper-plane text-success" aria-hidden="true"></i> Q.A ok</a></li>';

          // switch (data.task.status) {
          //     case -1:
          //     case 0:
          //         mn += '<li id="unregister-task"><a tabindex="-1" href="#"> <i class="fa fa-minus text-danger" aria-hidden="true"></i> Unregister</a></li>';
          //         break;
          //     case 1:
          //         mn = '<li id="submit-task"><a tabindex="-1" href="#"> <i class="fa fa-paper-plane text-success" aria-hidden="true"></i> Q.A ok</a></li>';
          //         mn += '<li id="reject-task"><a tabindex="-1" href="#"> <i class="fa fa-ban text-danger" aria-hidden="true"></i> Reject</a></li>';
          //         mn += '<li id="unregister-task"><a tabindex="-1" href="#"> <i class="fa fa-minus text-danger" aria-hidden="true"></i> Unregister</a></li>';
          //         break;

          //     default:
          //         $contextMenu.css({
          //             display: "none"
          //         });
          //         break;

          // }
          $('#funcMenu').append(mn);
        }
      })


      $('html').click(function () {
        $contextMenu.hide();
      });

    });



    $(document).on("click", "button[name='btn-job-info']", function () {
      jobId = $(this).closest("tr").attr("id");
      customerId = $(this).closest("tr").data("customer");
      $('#JobDetailModal').modal();

    })

    $(document).on("click", "button[name='edit-job']", function () {
      jobId = $(this).closest("tr").attr("id");
      $('#updateJobModal').modal();

    })

    $(document).ready(function () {
      LoadJobs();
    });

    $('#updateJobModal').on('hidden.bs.modal', function () {
      LoadJobs();
    })

    $('#btnSearch').click(function () {
      search = $('#txtSearch').val();
      LoadJobs();
    })



    $('#txtSearch').keyup(function (e) {
      if (e.keyCode == 13) {
        $("#btnSearch").click()
      }
    });


    function LoadJobs() {
      $.ajax({
        url: "/accountant/job/list",
        type: "get",
        headers: {
          authorization: "Bearer " + localStorage.getItem("accessToken"),
        },
        data: {
          search,
          page,
        },
        success: function (data) {
          $('#tblJobs').empty();
          let idx = 1;
          data.jobs.forEach(j => {
            let tr = '<tr id="' + j._id + '">';
            tr += '<td>  <input type="checkbox" name="ckb_ticked"></td>';
            tr += '<td>' + (idx++) + '</td>';
            tr += '<td class="font-weight-bold text-primary">' + j.customer.firstname + ' ' + j.customer.lastname + '</td>';
            tr += '<td class="font-weight-bold text-warning">' + j.name + '</td>';
            tr += '<td>' + convertISODateToTimeFormat(j.received_date) + '</td>';
            tr += '<td>' + convertISODateToTimeFormat(j.delivery_date) + '</td>';

            tr += '<td>';

            /*            
           0: Processing
           1:Upload   
           2:Done
           3: finish

           -1: initial
           -2:'Rejected
           
           - 3: Canceled           
       */

            switch (j.status) {
              case -1: tr += '<i class="text-info">Initial</i>'; break;
              case 0: tr += '<i class="text-primary">Processing</i>'; break;
              case 1: tr += '<i class="text-warning">Uploaded</i>'; break;
              case 2: tr += '<i class="text-warning">Done</i>'; break;
              case 3: tr += '<i class="text-success">Finish</i>'; break;
              case -2: tr += '<i class="text-danger">Rejected</i>'; break;
              case -3: tr += '<i class="text-danger">Canceled</i>'; break;
            }

            tr += '</td>';


            tr += '<td>';
            tr += '<button class="btn btn-xs parents js-view-parents fa fa-plus" name="js-view-parents"></button>';
            tr += '</td>';
            tr += '</tr> ';
            $('#tblJobs').append(tr);

          })


        },
        error: function (jqXHR, textStatus, errorThrown) {
          alert(jqXHR.responseJSON.msg + ". " + jqXHR.responseJSON.error);
        },
      });
    }


  </script>

  <style>
    /* #contextMenu {
      position: absolute;
      display: none;
    }

    tr:hover {
      background: #c9e8f7;
      position: relative;
    } */


    /* #myTable thead>tr>th.detail,
    #myTable tbody>tr:not(.detail-view)>td:first-of-type {
      display: none;
    }

    #myTable thead>tr>th:nth-child(2),
    #myTable tbody>tr:not(.detail-view)>td:nth-child(2) {
      border-left: none !important;
    } */
  </style>