<div class="row mt-2">
    <div class="col-md-offset-6 col-md-2 col-sm-offset-5 col-sm-3 col-xs-6">
        <select name="" id="slModules" class="form-control"></select>
    </div>

    <div class="col-md-4 col-sm-4 col-xs-6 text-right">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Seach job..." id="txtSearch" />
            <div class="input-group-btn">
                <button class="btn btn-info" type="submit" id="btnSearch">
                    <i class="fa fa-search" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-2">
    <div class="col-md-6">
        <div class="panel panel-success">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-md-10">
                        Check out
                    </div>
                    <div class="col-md-2 text-right">
                        <button class="btn btn-xs btn-danger" id="btnCheckOut">
                            <i class="fa fa-sign-in" aria-hidden="true"></i>
                            Check Out
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <div class="tableFixHead table-responsive mt-2">
                    <table class="table mt-1 table-striped bg-white text-dark text-nowrap">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Username</th>
                                <th scope="col">Fullname</th>
                            </tr>
                        </thead>
                        <tbody id="tblCheckIn">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="panel panel-danger">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-md-10">
                        Check out
                    </div>
                    <div class="col-md-2 text-right">
                        <button class="btn btn-xs btn-success" id="btnCheckIn">
                            <i class="fa fa-sign-in" aria-hidden="true"></i>
                            Check In
                        </button>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <div class="tableFixHead table-responsive mt-2">
                    <table class="table mt-1 table-striped bg-white text-dark text-nowrap">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">
                                    <input type="checkbox" name="ckbCheckOutAll">
                                </th>
                                <th scope="col">Username</th>
                                <th scope="col">Fullname</th>
                            </tr>
                        </thead>
                        <tbody id="tblCheckOut">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
        LoadModules();
        $('#btnCheckIn').hide();
        $('#btnCheckOut').hide();
    })

    $('#btnSearch').click(function(){      
        LoadStaffs($('#slModules option:selected').val());
    })

    $('#btnCheckOut').click(function(){
        $.ajax({
            url:'/tla/checkin/out',
            type:'put',
            headers: {
                authorization: "Bearer " + localStorage.getItem("accessToken"),
            },
            data:{
                checkOut
            },
            success:function(data){
                $('#btnCheckOut').hide();
                LoadStaffs($('#slModules option:selected').val());
            }
        })
    })

    $('#btnCheckIn').click(function(){
        $.ajax({
            url:'/tla/checkin/in',
            type:'put',
            headers: {
                authorization: "Bearer " + localStorage.getItem("accessToken"),
            },
            data:{
                checkIn
            },
            success:function(data){
                $('#btnCheckIn').hide();
                LoadStaffs($('#slModules option:selected').val());
            }
        })
    })

    let checkIn = [];
    let checkOut = [];

    $('#tblCheckIn').on("click", "input[name='ckbCheckIn']", function () {
        let staffId = $(this).closest('tr').attr('id');
       
        chk = checkOut.filter(x=>x == staffId);
        if(chk.length === 0){
            checkOut.push(staffId)
        }else{
            checkOut = checkOut.filter(x=>x!==staffId);
        }

        console.log(checkOut)
        if(checkOut.length>0){
            $('#btnCheckOut').show();
        }else{
            $('#btnCheckOut').hide();
        }       
    })




    $('#tblCheckOut').on("click", "input[name='ckbCheckOut']", function () {
        let staffId = $(this).closest('tr').attr('id');
       
        chk = checkIn.filter(x=>x == staffId);
        if(chk.length === 0){
            checkIn.push(staffId)
        }else{
            checkIn = checkIn.filter(x=>x!==staffId);
        }

        if(checkIn.length>0){
            $('#btnCheckIn').show();
        }else{
            $('#btnCheckIn').hide();
        }       
    })

    function LoadModules() {
        $.ajax({
            url: '/tla/checkin/list-modules',
            type: 'get',
            headers: {
                authorization: "Bearer " + localStorage.getItem("accessToken"),
            },
            success: function (data) {
                data.modules.forEach(m => {
                    $('#slModules').append('<option value="' + m._id + '">' + m.name + '</option>');
                })

                LoadStaffs($('#slModules option:selected').val());
            }

        })
    }

    $('#slModules').on("change", function () {
        LoadStaffs($('#slModules option:selected').val());
    })

    function LoadStaffs(moduleId) {       
        $.ajax({
            url: '/tla/checkin/list-staffs-by-module',
            type: 'get',
            headers: {
                authorization: "Bearer " + localStorage.getItem("accessToken"),
            },
            data: { moduleId },
            success: function (data) {
                $('#tblCheckIn').empty();
                $('#tblCheckOut').empty();

                data.checkOut.forEach(u => {
                    let tr = '<tr id="' + u._id + '">';
                    tr += '<td> <input type="checkbox" name="ckbCheckOut" ></td>';
                    tr += '<td class="font-weight-bold">' + u.username + '</td>';
                    tr += '<td>' + u.fullname + '</td>';
                    tr += '</tr>';
                    $('#tblCheckOut').append(tr);
                })

                data.checkIn.forEach(u => {
                    let tr = '<tr id="' + u._id + '">';
                    tr += '<td> <input type="checkbox" name="ckbCheckIn" ></td>';
                    tr += '<td class="font-weight-bold">' + u.username + '</td>';
                    tr += '<td>' + u.fullname + '</td>';
                    tr += '</tr>';
                    $('#tblCheckIn').append(tr);
                })
            }
        })
    }
</script>