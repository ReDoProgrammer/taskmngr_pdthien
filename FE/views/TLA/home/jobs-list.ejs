<div class="row">
    <div class="offset-md-7 col-md-2">
        <select name="" id="" class="form-control">
            <option value="">Open</option>
            <option value="">Processing</option>
            <option value="">Upload</option>
            <option value="">Reject</option>
            <option value="">Cancel</option>
            <option value="">Done</option>
        </select>
    </div>

    <div class="col-md-3 text-right">
        <!-- Another variation with a button -->
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search ..." />
            <div class="input-group-append">
                <button class="btn btn-warning" type="button">
                    <i class="fa fa-search text-danger"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="tableFixHead" id="tblMaster">

    <table class="table mt-1 table-striped bg-white text-dark">
        <thead class="thead-dark">
            <tr>
                <th scope="col">#</th>
                <th scope="col">Customer</th>
                <th scope="col">Job name</th>
                <th scope="col">Intruction</th>
                <th scope="col">Received date</th>
                <th scope="col">Delivery date</th>
                <th scope="col">Status</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tblData">
        </tbody>
    </table>
</div>

<script type='text/javascript'
  src="https://rawgit.com/RobinHerbots/jquery.inputmask/3.x/dist/jquery.inputmask.bundle.js"></script>


<%-include('assign-job-modal')%>

    <script>
        var search = '';
        var page = 1;
        var jobId = '';
        

        $(document).ready(function () {
            LoadJob();
            LoadLevels();
        })




        function LoadJob() {
            $.ajax({
                url: '/tla/job/list',
                type: 'get',
                headers: {
                    authorization: "Bearer " + localStorage.getItem("accessToken"),
                },
                data: {
                    search,
                    page
                },
                success: function (data, textStatus, xhr) {
                    let idx = 1;
                    data.jobs.forEach(job => {
                        let tr = '<tr id = "' + job._id + '">';
                        tr += '<td>' + (idx++) + '</td>'
                        tr += '<td>' + job.customer.firstname + ' ' + job.customer.lastname + '</td>';
                        tr += '<td>' + job.name + '</td>';
                        tr += '<td>' + job.intruction + '</td>';
                        tr += "<td>" + new Date(job.received_date).toLocaleString() + "</td>";
                        tr += "<td>" + new Date(job.delivery_date).toLocaleString() + "</td>";
                        tr += '<td class = "text-info"><i>';
                        switch (job.status) {
                            case -1:
                                tr += 'Initial';
                                break;
                            case 0:
                                tr += 'Processing';
                                break;
                            case 1:
                                tr += 'Upload';
                                break;
                            case 2:
                                tr += 'Done';
                                break;
                            case -2:
                                tr += 'Rejected';
                                break;
                            case -3:
                                tr += 'Canceled';
                                break;
                        }
                        tr += '</i></td>';
                        tr += '<td class="font-weight-bold"><button class="btn btn-sm btn-info" name="assign-job"><i class="fa fa-tasks text-warning" aria-hidden="true"></i> Assign level</button></td>'
                        tr += '</tr>';
                        $('#tblData').append(tr);
                    })

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseJSON.msg + ". " + jqXHR.responseJSON.error);
                }
            })
        }


        $(document).on("click", "button[name='assign-job']", function () {
            jobId = $(this).closest("tr").attr("id");
            $.ajax({
                url: '/tla/job/detail',
                type: 'get',
                headers: {
                    authorization: "Bearer " + localStorage.getItem("accessToken"),
                },
                data: {
                    id: jobId
                },
                success: function (data, textStatus, xhr) {

                    $('#assignJobModal').modal();                    

                    $('#customer_fullname').text(data.job.customer.firstname + ' ' + data.job.customer.lastname);
                    $('#name_case').text(data.job.name);
                    $('#customer_remark').text(data.job.customer.remark);
                    $('#job_intruction').text(data.job.intruction);
                    if (data.job.customer.has_fire) {
                        if (data.job.customer.fire_note.trim().length > 0) {
                            $('#customer_fire').html(data.job.customer.fire_note);
                        } else {
                            $('#customer_fire').html('<i class="fa fa-check-square-o text-success" aria-hidden="true"></i>');
                        }
                    } else {
                        $('#customer_fire').html('<i class="fa fa-square-o" aria-hidden="true"></i>');
                    }

                    if (data.job.customer.has_grass) {
                        if (data.job.customer.grass_note.trim().length > 0) {
                            $('#customer_grass').html(data.job.customer.grass_note);
                        } else {
                            $('#customer_grass').html('<i class="fa fa-check-square-o text-success" aria-hidden="true"></i>');
                        }
                    } else {
                        $('#customer_grass').html('<i class="fa fa-square-o" aria-hidden="true"></i>');
                    }

                    if (data.job.customer.has_sky) {
                        if (data.job.customer.sky_note.trim().length > 0) {
                            $('#customer_sky').html(data.job.customer.sky_note);
                        } else {
                            $('#customer_sky').html('<i class="fa fa-check-square-o text-success" aria-hidden="true"></i>');
                        }
                    } else {
                        $('#customer_sky').html('<i class="fa fa-square-o" aria-hidden="true"></i>');
                    }

                    if (data.job.customer.has_TV) {
                        if (data.job.customer.TV_note.trim().length > 0) {
                            $('#customer_tv').html(data.job.customer.TV_note);
                        } else {
                            $('#customer_tv').html('<i class="fa fa-check-square-o text-success" aria-hidden="true"></i>');
                        }
                    } else {
                        $('#customer_tv').html('<i class="fa fa-square-o" aria-hidden="true"></i>');
                    }

                    if (data.job.customer.is_align) {
                        if (data.job.customer.align_note.trim().length > 0) {
                            $('#customer_align').html(data.job.customer.align_note);
                        } else {
                            $('#customer_align').html('<i class="fa fa-check-square-o text-success" aria-hidden="true"></i>');
                        }
                    } else {
                        $('#customer_align').html('<i class="fa fa-square-o" aria-hidden="true"></i>');
                    }



                    $('#customer_colormode').html('<i class="text-warning font-weight-bold">' + data.job.customer.color_mode.name + '</i>')
                    $('#customer_cloud').html('<i class="text-warning font-weight-bold">' + data.job.customer.cloud.name + '</i>')
                    $('#customer_nationalstyle').html('<i class="text-warning font-weight-bold">' + data.job.customer.national_style.name + '</i>')
                    $('#customer_output').html('<i class="text-warning font-weight-bold">' + data.job.customer.output.name + '</i>')
                    $('#customer_size').html('<i class="text-warning font-weight-bold">' + data.job.customer.size.name + '</i>')

                }
            })
        })



    
        function LoadLevels(){
            $.ajax({
                url:'/tla/level',
                type:'get',
                headers: {
                    authorization: "Bearer " + localStorage.getItem("accessToken"),
                },
                success:function(data){
                    console.log(data);
                    data.levels.forEach(l=>{
                       
                    })
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseJSON.msg + ". " + jqXHR.responseJSON.error);
                }
            })
        }
    
    </script>


    <style>
        .tableFixHead {
            overflow: auto;
        }

        #tblMaster {
            height: 500px;
            overflow-y: auto;
        }

        


        .tableFixHead thead th {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Just common table stuff. Really. */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            padding: 8px 16px;
        }

        th {
            background: #eee;
        }
    </style>