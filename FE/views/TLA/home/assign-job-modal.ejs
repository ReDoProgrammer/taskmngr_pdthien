<script src="/js/bootstrap-select.min.js"></script>
<script src="/js/common.js"></script>
<link href="/css/bootstrap-select.min.css" rel="stylesheet" />
<script type='text/javascript'
  src="https://rawgit.com/RobinHerbots/jquery.inputmask/3.x/dist/jquery.inputmask.bundle.js"></script>

<div class="modal" tabindex="-1" id="assignJobModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body text-dark">
        <div class="panel panel-info mb-3">
          <div class="panel-heading font-weight-bold">Summary</div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-2 col-sm-3 col-xs-4">
                <label class="font-weight-bold">Job name:</label>
              </div>
              <div class="col-md-10 col-sm-9 col-xs-8">
                <label id="name_case" class="font-weight-bold font-italic"></label>
              </div>
            </div>
            <div class="row">
              <div class="col-md-2 col-sm-3 col-xs-4">
                <label class="font-weight-bold">Remark:</label>
              </div>
              <div class="col-md-10 col-sm-9 col-xs-8">
                <label id="customer_remark" class="text-warning"></label>
              </div>
            </div>

            <div class="row">
              <div class="col-md-2 col-sm-3 col-xs-4">
                <label class="font-weight-bold">Intruction:</label>
              </div>
              <div class="col-md-10 col-sm-9 col-xs-8">
                <label id="job_intruction" class="text-warning"></label>
              </div>
            </div>

            <div class="row mt-2">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <button class="btn btn-sm btn-success" id="btnAddTask"><i class="fa fa-plus"></i> Add Task</button>
              </div>
            </div>
          </div>
        </div>





        <div class="table-responsive  table-responsive-sm table-responsive-xs mt-2">
          <table class="table mt-1 table-striped bg-white text-dark nowrap text-nowrap">
            <thead class="thead-dark">
              <tr>

                <th scope="col">#</th>
                <th scope="col">Assign</th>
                <th scope="col">Level</th>
                <th scope="col">Assign date</th>
                <th scope="col">Deadline</th>
                <th scope="col">Remark</th>
                <th scope="col">Editor</th>
                <th scope="col">Q.A</th>
                <th scope="col">Link</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tblTasks"></tbody>
          </table>
        </div>

        <%-include('child/assign-task')%>
          <%-include('child/assign-staff')%>
            <%-include('child/edit-task')%>



              <div class="form-row">
                <div class="col-sm-12">
                  <label class="font-weight-bold text-danger mt-3" id="msgError"></label>
                </div>
              </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>




<script type="text/javascript">
  let idx = 1;
  var taskId = '';
  var levelId = '';

  //sự kiện click button sửa task trên table

  $(document).on("click", "button[name='btnEditTask']", function () {
    taskId = $(this).closest("tr").attr("id");
    levelId = $(this).closest("tr").data('level');
    LoadEditor();
    LoadQA();

    $.ajax({
      url: '/tla/task/detail',
      type: 'get',
      headers: {
        authorization: "Bearer " + localStorage.getItem("accessToken"),
      },
      data: {
        taskId
      },
      success: function (data) {
        console.log(data);
          $('#slJobLevelsInEditDiv').val(data.task.level);
          $('#txtAssignDateInEditDiv').val(convertISODateToTimeFormat(data.task.assigned_date));
          $('#txtDeadlineInEditDiv').val(convertISODateToTimeFormat(data.task.deadline));
          $('#txtInputLinkInEditDiv').val(data.task.input_link);
          $('#txtRemarkInEditDiv').val(data.task.remark);

          if(data.task.editor_assigned){
            $('#colEditor').show();
            $('#slEditorInEditDiv').val(data.task.editor);
          }else{
            $('#colEditor').hide();
          }
          if(data.task.qa_assigned){
            $('#colQA').show();
            $('#slQAInEditDiv').val(data.task.qa);
          }else{
            $('#colQA').hide();
          }

      }
    })
  })

  $(document).on("click", "button[name='btnAssignStaffAuto']", function () {

    $.ajax({
      url: '/tla/queue',
      type: 'post',
      headers: {
        authorization: "Bearer " + localStorage.getItem("accessToken"),
      },
      data: {
        levelId: $(this).closest("tr").data('level')
      },
      success: function (data) {
        console.log(data);
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $('#msgError').text(jqXHR.responseJSON.msg);
        $('#msgError').show().delay(5000).fadeOut();
      }
    })
  })

  $('#btnAddTask').click(function () {
    $('#divLevel').slideDown(1000);
    $('#divAssign').slideUp(200);
    $('#divEditTask').slideUp(200);
    $("button[name='btnAssignStaff']").show(100);
    $("button[name='btnDelTask']").show(100);
  })

  $('.btnCancel').on('click', function () {
    $('#divAssign').slideUp(500);
    $('#divLevel').slideUp(500);
    $('#divEditTask').slideUp(500);
    $("button[name='btnAssignStaff']").show(100);
    $("button[name='btnDelTask']").show(100);
    taskId = '';
  })











  $("#assignJobModal").on('shown.bs.modal', function (e) {
    LoadTasks();
    LoadJobLevels();
    $('#divLevel').hide();
    $('#divEditTask').hide();
    $('#divAssign').hide();
    $('#txtAssignDate').val(getCurrentTime())
  });


  $(document).ready(function () {
    $('#divAssign').hide();
    $('#divEditTask').hide();
  })

  function ChangeJobStatus(jobId, status) {
    $.ajax({
      url: '/tla/job/change-status',
      type: 'put',
      headers: {
        authorization: "Bearer " + localStorage.getItem("accessToken"),
      },
      data: {
        jobId,
        status
      },
      success: function (data) {
        console.log(data.msg);
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $('#msgError').text(jqXHR.responseJSON.msg);
      }
    })
  }


  $(document).on("click", "button[name='btnEditTask']", function () {
    $('#divAssign').hide(100);
    $('#divLevel').hide(100);
    $('#divEditTask').slideDown(1000);

  })

  $(document).on("click", "button[name='btnAssignStaff']", function () {
    taskId = $(this).closest("tr").attr("id");
    levelId = $(this).closest("tr").data('level');

    if ($(this).closest("tr").data('editor') == 0) {
      $('#divEditor').show();
    } else {
      $('#divEditor').hide();
    }

    if ($(this).closest("tr").data('qa') == 0) {
      $('#divQA').show();
    } else {
      $('#divQA').hide();
    }


    LoadEditor();
    LoadQA();

    $('#divAssign').slideDown(1000);
    $('#divLevel').slideUp(500);
    $('#divEditTask').slideUp(500);
    $("button[name='btnAssignStaff']").fadeOut(100);
    $("button[name='btnDelTask']").fadeOut(100);
  })

  $(document).on("click", "button[name='btnDelTask']", function () {

    let _id = $(this).closest("tr").attr("id");
    if (confirm("Are you sure to delete this level?")) {
      $.ajax({
        url: '/tla/task',
        type: 'delete',
        headers: {
          authorization: "Bearer " + localStorage.getItem("accessToken"),
        },
        data: {
          _id
        },
        success: function (data) {
          $('#msgError').text(data.msg);
          $('#msgError').show();
          $('#msgError').hide(2000);
          LoadTasks();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          $('#msgError').text(jqXHR.responseJSON.msg);
        }
      })
    }
  })







  function LoadTasks() {
    $("#tblTasks").empty();
    $.ajax({
      url: '/tla/task/list',
      type: 'get',
      headers: {
        authorization: "Bearer " + localStorage.getItem("accessToken"),
      },
      data: {
        jobId
      },
      success: function (data) {
        let idx = 1;
        $("#tblTasks").empty();
        data.tasks.forEach(t => {
          let tr = '<tr id="' + t._id + '" data-level="' + t.level._id + '" data-editor="';
          tr += t.editor_assigned ? 1 : 0;
          tr += '" data-qa="';
          tr += t.qa_assigned ? 1 : 0;
          tr += '">';

          tr += "<td>" + idx++ + "</td>";

          tr += '<td>';
          if (!(t.editor_assigned && t.qa_assigned)) {
            tr += '<button class="btn btn-xs btn-primary" name="btnAssignStaff"><i class="fa fa-cog" aria-hidden="true"></i> Assign staff</button>';
            tr += '<button class="ml-2 btn btn-xs btn-warning" name="btnAssignStaffAuto"><i class="fa fa-refresh" aria-hidden="true"></i> Assign auto</button>';
          }
          tr += '</td>';


          tr += "<td class='font-weight-bold text-info'>" + t.level.name + "</td>";
          tr += "<td>" + convertISODateToTimeFormat(t.assigned_date) + "</td>";
          tr += "<td>" + convertISODateToTimeFormat(t.deadline) + "</td>";
          tr += "<td>" + t.remark + "</td>";






          tr += '<td>';
          if (t.editor_assigned)
            tr += t.editor.fullname;
          else tr += '';
          tr += "</td>";

          tr += '<td>';
          if (t.qa_assigned)
            tr += t.qa.fullname;
          else tr += '';

          tr+= '<td>';
          if(isValidHttpUrl(t.input_link)){
            tr+= '<a href="'+t.input_link+'" target="_blank">Link</a>'
          }else{
            tr+= t.input_link
          }

          tr+= '</td>'

          tr += '<td class="text-right">';
          tr += '<button class="ml-1 btn btn-xs btn-danger" name="btnDelTask"><i class="fa fa-trash text-white" aria-hidden="true"></i></button>';
          tr += '<button class="ml-1 btn btn-xs btn-warning" name="btnEditTask"><i class="fa fa-edit"></i></button>';
          tr += '</td>';

          tr += "</tr>";

          $("#tblTasks").append(tr);
        })
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $('#msgError').text(jqXHR.responseJSON.msg);
        $('#msgError').show().delay(3000).fadeOut();
      },
    });
  }





  $('.inputDate').inputmask("datetime", {
    mask: "1/2/y h:s",
    placeholder: "dd/mm/yyyy hh:mm",
    leapday: "-02-29",
    separator: "/",
    alias: "dd/mm/yyyy hh:mm"
  })




</script>

