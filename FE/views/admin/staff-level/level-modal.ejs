<div class="modal" tabindex="-1" id="modalLevel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add or update local level</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-2 col-sm-2 col-xs-2 font-weight-bold text-primary">Job level:</div>
                    <div class="col-md-8 col-sm-8 col-xs-8">
                        <select name="" id="slJobLevel" class="form-control"></select>
                    </div>
                    <div class="col-md-2 col-sm-2 col-xs-2">
                        <button class="btn btn-success" id="btnAddJobLevel">Add</button>
                    </div>
                </div>

                <div class="panel panel-primary mt-2">
                    <div class="panel-heading font-weight-bold">Job levels list</div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Level</th>
                                        <th scope="col"></th>
                                    </tr>
                                </thead>
                                <tbody id="tbSJData">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <label class="text-danger" id="msgError"></label>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(_ => {
        LoadJobLevels();
        $('#msgError').hide();
    })

    $(document).on("click", "button[name='deleteStaffJobLevel']", function () {

        var r = confirm("Are you sure want to delete " + $(this).closest("tr").data('name') + "?");
        if (r == true) {
            $.ajax({
                url: '/admin/staff-job-level',
                type: 'delete',
                headers: {
                    authorization: "Bearer " + localStorage.getItem('accessToken'),
                },
                data: {
                    sjId: $(this).closest("tr").attr("id")
                },
                success: function (data, textStatus, xhr) {
                    $('#msgError').show(100);
                    $('#msgError').text(data.msg);
                    $('#msgError').hide(3000);
                    LoadStaffJobLevel(levelId);
                }, error: function (jqXHR, textStatus, errorThrown) {
                    $('#msgError').show(100);
                    $('#msgError').text(jqXHR.responseJSON.msg);
                    $('#msgError').hide(3000);
                }
            })
        }


    });


    $('#modalLevel').on('shown.bs.modal', function (e) {
        LoadStaffJobLevel(levelId);
    })


    function LoadStaffJobLevel(levelId) {       
        $.ajax({
            url: '/admin/staff-job-level',
            type: 'get',
            headers: {
                authorization: "Bearer " + localStorage.getItem('accessToken'),
            },
            data: {
                levelId
            },
            success: function (data) {

                $('#tbSJData').empty();
                let idx = 1;
                data.sjl.forEach(s => {
                    let tr = '<tr id = "' + s._id + '" data-name="' + s.job_lv.name + '">';
                    tr += '<td>' + (idx++) + '</td>';
                    tr += '<td class ="font-weight-bold text-danger">' + s.job_lv.name + '<td>';
                    tr += '<td class="text-right"><button class="btn btn-xs btn-danger ml-1" name="deleteStaffJobLevel"><i class="fa fa-trash" aria-hidden="true"></i></button></td>'
                    tr += '</tr>';
                    $('#tbSJData').append(tr);
                })
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('#msgError').show(100);
                $('#msgError').text(jqXHR.responseJSON.msg);
                $('#msgError').hide(3000);
            }
        })
    }

    $('#btnAddJobLevel').click(function () {
        let jobLevelId = $('#slJobLevel option:selected').val();


        $.ajax({
            url: '/admin/staff-job-level',
            type: 'post',
            headers: {
                authorization: "Bearer " + localStorage.getItem('accessToken'),
            },
            data: {
                jobLevelId,
                staffLevelId: levelId
            },
            success: function (data) {
                $('#msgError').show(100);
                $('#msgError').text(data.msg);
                $('#msgError').hide(3000);
                LoadStaffJobLevel(levelId)
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('#msgError').show(100);
                $('#msgError').text(jqXHR.responseJSON.msg);
                $('#msgError').hide(5000);
            }
        })
    })

    function LoadJobLevels() {
        $.ajax({
            url: '/admin/job-level',
            type: 'get',
            headers: {
                authorization: "Bearer " + localStorage.getItem('accessToken'),
            },
            success: function (data) {
                $('#slJobLevel').empty();
                data.jl.forEach(j => {
                    let opt = '<option value="' + j._id + '" class="font-weight-bold text-warning">' + j.name + '</option>';
                    $('#slJobLevel').append(opt);
                })
            }, error: function (jqXHR, textStatus, errorThrown) {
                $('#msgError').show(100);
                $('#msgError').text(jqXHR.responseJSON.msg);
                $('#msgError').hide(3000);
            }
        })

    }
</script>