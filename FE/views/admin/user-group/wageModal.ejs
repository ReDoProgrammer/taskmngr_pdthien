<div class="modal fade" id="modalWage" tabindex="-1" aria-labelledby="modalWage" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="panel panel-primary">
                    <div class="panel-heading"> Add or update wage</div>
                    <div class="panel-body">

                        <div class="form-row">
                            <div class="form-group col-md-3 col-sm-3 col-xs-4">
                                <label for="recipient-name" class="col-form-label">Role:</label>
                                <select name="" id="slRoles" class="form-control"></select>
                            </div>
                            <div class="form-group col-md-3 col-sm-3 col-xs-4">
                                <label for="recipient-name" class="col-form-label">Staff level:</label>
                                <select name="" id="sllStaffLevels" class="form-control"></select>
                            </div>
                            <div class="form-group col-md-2 col-sm-2 col-xs-4">
                                <label for="recipient-name" class="col-form-label">Wage:</label>
                                <input type="text" class="form-control text-right" id="txtWage" value="0" />
                            </div>

                            <div class="form-group col-md-2 col-sm-2 col-xs-6 text-right">
                                <label for="recipient-name" class="col-form-label"></label><br>
                                <button class="btn btn-sm btn-success mt-1" id="btnSubmitWage">
                                    <i class="fa fa-plus" aria-hidden="true"></i>
                                    Add
                                </button>                               
                            </div>

                            <div class="form-group col-md-2 col-sm-2 col-xs-6">
                                <label for="recipient-name" class="col-form-label"></label><br>
                                <button class="btn btn-sm btn-secondary mt-1" id="btnCancel">
                                    Cancel
                                </button>
                            </div>

                        </div>

                        <table class="table table-striped mt-2">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Module</th>
                                    <th scope="col">Level</th>                                   
                                    <th scope="col" class="text-right">Wage</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody id="tblWages"></tbody>
                        </table>

                        <div class="form-row">
                            <div class="col-md-12 col-xs-12 text-danger font-weight-bold" id="lblError"></div>
                        </div>


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var _id = '';
            $(document).ready(function () {
                LoadRoles();
                LoadStaffLevels();
                $('#lblError').hide();
            })

            $("#tblWages").on("click", "button[name='deleteWage']", function () {
                let _id = $(this).closest("tr").attr("id");
                var r = confirm(
                    "Are you sure want to delete this wage?"
                );
                if (r) {
                    $.ajax({
                        url: '/admin/user-group-wage',
                        type: 'delete',
                        headers: {
                            authorization: "Bearer " + localStorage.getItem('accessToken'),
                        },
                        data: {
                            _id
                        },
                        success: function (data) {
                            alert(data.msg);
                            LoadWages();
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $('#lblError').text(jqXHR.responseJSON.msg);
                            $('#lblError').show();
                        }

                    })
                }
            })

            $('#btnCancel').click(function () {
                _id = '';
                $('#txtWage').val(0);
                $('#btnSubmitWage').html('<i class="fa fa-plus" aria-hidden="true"></i>Add');
                $('#btnSubmitWage').addClass('btn-success').removeClass('btn-warning');
            })

            $("#tblWages").on("click", "button[name='updateWage']", function () {
                _id = $(this).closest("tr").attr("id");
                $.ajax({
                    url: '/admin/user-group-wage/detail',
                    type: 'get',
                    headers: {
                        authorization: "Bearer " + localStorage.getItem('accessToken'),
                    },
                    data: {
                        _id
                    },
                    success: function (data) {
                        $('#slRoles').val(data.w.skill);
                        $('#slStaffLevels').val(data.w.skill);
                        $('#txtWage').val(data.w.wage);
                        $('#btnSubmitWage').html('<i class="fa fa-refresh" aria-hidden="true"></i> Update');
                        $('#btnSubmitWage').addClass('btn-warning').removeClass('btn-success');
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('#lblError').text(jqXHR.responseJSON.msg);
                        $('#lblError').show();
                    }
                })
            })




            $('#modalWage').on('shown.bs.modal', function (e) {
                LoadWages();
                $('#lblError').text('');
                $('#lblError').hide();
                $('#txtWage').text('0');
            })



            $('#btnSubmitWage').click(function () {
                let module = $('#slRoles option:selected').val();
                let level = $('#sllStaffLevels option:selected').val();
                let wage = parseFloat($('#txtWage').val());
              
                if (_id.trim().length > 0) {//update exist record
                    $.ajax({
                        url: '/admin/user-group-wage',
                        type: 'put',
                        headers: {
                            authorization: "Bearer " + localStorage.getItem('accessToken'),
                        },
                        data: {
                            _id,
                            user_group: ugId,
                            module,
                            level,
                            wage
                        },
                        success: function (data) {   
                            alert(data.msg);                       
                            LoadWages();
                            $('#btnCancel').click();
                            $('#txtWage').text('0');
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $('#lblError').text(jqXHR.responseJSON.msg);
                            $('#lblError').show();
                        }

                    })
                } else {
                    $.ajax({
                        url: '/admin/user-group-wage',
                        type: 'post',
                        headers: {
                            authorization: "Bearer " + localStorage.getItem('accessToken'),
                        },
                        data: {
                            user_group: ugId,
                            module,
                            level,
                            wage
                        },
                        success: function (data) {                          
                            LoadWages();
                            $('#txtWage').text('0');
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $('#lblError').text(jqXHR.responseJSON.msg);
                            $('#lblError').show();
                        }

                    })
                }


            })

            function LoadWages() {
                $.ajax({
                    url: '/admin/user-group-wage',
                    type: 'get',
                    headers: {
                        authorization: "Bearer " + localStorage.getItem('accessToken'),
                    },
                    data: {
                        ugId
                    },
                    success: function (data) {
                        $('#tblWages').empty();
                        data.wages.forEach(w => {
                            let tr = '<tr id = "' + w._id + '">';
                            tr += '<td class="font-weight-bold text-info">' + w.module.name + '</td>';
                            tr += '<td class="text-warning font-weight-bold">' + w.level.name + '</td>';
                           
                            tr += '<td class="text-danger font-weight-bold text-right">' + w.wage + '</td>';
                            tr +=
                                '<td class="text-right"><button class="btn btn-xs btn-warning ml-1" name="updateWage"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>';
                            tr +=
                                '<button class="btn btn-xs btn-danger ml-1" name="deleteWage"><i class="fa fa-trash" aria-hidden="true"></i></button></td>';


                            tr += "</tr>";
                            tr += '</tr>';
                            $('#tblWages').append(tr);
                        })
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        $('#lblError').text(jqXHR.responseJSON.msg);
                        $('#lblError').show();
                    }
                })
            }

            $("#txtWage").on("keypress keyup blur", function (event) {
                //this.value = this.value.replace(/[^0-9\.]/g,'');
                $(this).val($(this).val().replace(/[^0-9\.]/g, ''));
                if ((event.which != 46 || $(this).val().indexOf('.') != -1) && (event.which < 48 || event.which > 57)) {
                    event.preventDefault();
                }
            });


            function LoadStaffLevels() {
                $.ajax({
                    url: '/admin/staff-level',
                    type: 'get',
                    headers: {
                        authorization: "Bearer " + localStorage.getItem('accessToken'),
                    },
                    success: function (data) {
                        $('#sllStaffLevels').empty();
                        data.levels.forEach(l => {
                            let opt = '<option value="' + l._id + '">' + l.name + '</option>';
                            $('#sllStaffLevels').append(opt);
                        })
                    }
                })
            }

            function LoadRoles() {

                $.ajax({
                    url: '/admin/module/list-appling-wage',
                    type: 'get',
                    headers: {
                        authorization: "Bearer " + localStorage.getItem('accessToken'),
                    },
                    success: function (data) {                      
                        $('#slRoles').empty();
                        data.ms.forEach(s => {
                            let opt = '<option value="' + s._id + '">' + s.name + '</option>';
                            $('#slRoles').append(opt);
                        })
                    }
                })
            }
        </script>