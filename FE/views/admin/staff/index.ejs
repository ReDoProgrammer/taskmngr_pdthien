<div class="row">
  <div class="col-md-7">
    <nav aria-label="Page navigation example">
      <ul class="pagination" id="paginantion"></ul>
    </nav>
  </div>
  <div class="col-md-3 text-right">
    <!-- Another variation with a button -->
    <div class="input-group">
      <input type="text" class="form-control" placeholder="Search this blog" id="txtSearch" />
      <div class="input-group-append">
        <button class="btn btn-secondary" type="button" id="btnSearch">
          <i class="fa fa-search"></i>
        </button>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <button class="btn btn-info" id="btnAddStaff">
      <span>
        <i class="fa fa-plus" aria-hidden="true"></i>
      </span>
      Add New
    </button>
  </div>
</div>
<table class="table mt-1">
  <thead class="thead-light">
    <tr>
      <th scope="col">#</th>
      <th scope="col">Fullname</th>
      <th scope="col">Phone</th>
      <th scope="col">Email</th>
      <th scope="col">Address</th>
      <th scope="col">Role</th>
      <th scope="col">Status</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="tblUsers"></tbody>
</table>


<%-include('modal')%>

  <script>
    var userId = '';
    var search = '';
    var page = 1;
    is_readonly = false;
    $(document).ready(() => {
      $("#direction").val("Employee Management");
      LoadUsers();
    });

    $(document).on("click", "button[name='btnEditUser']", function () {
      userId = $(this).closest("tr").attr("id");
      $('#modalStaff').modal();
    })
    $(document).on("click", "button[name='btnDelUser']", function () {
      if (confirm("Are you really want to delete this user?")) {
        userId = $(this).closest("tr").attr("id");
        $.ajax({
          url: '/admin/user',
          type: 'delete',
          headers: {
            authorization: "Bearer " + localStorage.getItem('accessToken'),
          },
          data: {
            userId
          }, success: function (data) {
            alert(data.msg);
            LoadUsers();
            userId = '';
          }, error: function (jqXHR, textStatus, errorThrown) {
            alert(jqXHR.responseJSON.msg);
          }
        })
      }
    })
    $(document).on("click", "button[name='btnUserInfo']", function () {
      userId = $(this).closest("tr").attr("id");
      $('#modalStaff').modal();
      is_readonly = true;
    })



    $('#modalStaff').on('hidden.bs.modal', function () {
      LoadUsers();
      is_readonly = false;
    })


    $('#btnAddStaff').click(function () {
      $('#txtFullname').val('');
      $('#txtPhone').val('');
      $('#txtEmail').val('');
      $('#txtUsername').val('');
      $('#txtPassword').val('123');
      $('#txtConfirmPassword').val('123');
      $('#txtIDNo').val('');
      $('#txtIssuedBy').val('');
      $('#txtAddress').val('');
      $('#txtBankNo').val('');
      $('#txtBankName').val('');
      $('#modalStaff').modal();
    })

    $('#btnSearch').click(function () {
      search = $('#txtSearch').val();
      page = 1;
      LoadUsers();
    })

    function LoadUsers() {
      $.ajax({
        url: '/admin/user',
        type: 'get',
        headers: {
          authorization: "Bearer " + localStorage.getItem('accessToken'),
        },
        data: {
          search,
          page
        },
        success: function (data, textStatus, xhr) {
          $('#tblUsers').empty();
          let idx = 1;
          Pagination(data.pages);
          data.users.forEach(user => {
            let tr = '<tr id="' + user._id + '">';
            tr += '<td>' + (idx++) + '</td>';
            tr += '<td class = "font-weight-bold text-info"><a href ="' + user._id + '" class="table_row">' + user.fullname + '</a></td>';
            tr += '<td>' + user.phone + '</td>';
            tr += '<td>' + user.email + '</td>';
            tr += '<td>' + user.address + '</td>';

            tr += '<td class="text-info font-italic">';
            if (user.is_admin) tr += 'Administrator';
            else if (user.is_dc) tr += 'DC';
            else if (user.is_sale) tr += 'Sale';
            else if (user.is_tla) tr += 'TLA';
            else if (user.is_qa) tr += 'Q.A'
            else if (user.is_editor) tr += 'Editor';
            else if (user.is_accountant) tr += 'Accountant'
            tr += '</td>';

            if (user.is_active) {
              tr += '<td class="text-success">Active</td>';
            } else {
              tr += '<td class="text-danger">Unactive</td>';
            }

            tr += '<td>';
            tr += '<button class="btn btn-sm btn-info mr-1" name="btnUserInfo"><i class="fa fa-info-circle" aria-hidden="true"></i></button>';
            if (!user.is_admin) {
              tr += '<button class="btn btn-sm btn-warning mr-1" name="btnEditUser"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></button>';
              tr += '<button class="btn btn-sm btn-danger" name="btnDelUser"><i class="fa fa-trash" aria-hidden="true"></i></button>';
            }
            tr += '</td>';


            tr += '</tr>';
            $('#tblUsers').append(tr);
          })
        }, error: function (jqXHR, textStatus, errorThrown) {
          alert(jqXHR.responseJSON.msg);
        }
      })
    }



    $(document).ready(function () {
      $('a.table_row').on("click", function (e) {
        e.preventDefault();
      })
      $('#tblUsers tr').click(function (e) {
        userId = $(this).find('a').attr('href');
        console.log(userId);
      })
    })

    function Pagination(pages) {
      $('#pagination').empty();
      for (i = 1; i <= pages; i++) {
        let li = '<li class="page-item"><a class="page-link" href="#">1</a></li>';
        $('#pagination').append(li);
      }
    }
  </script>